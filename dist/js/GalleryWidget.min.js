(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Maslosoft||(this.Maslosoft={}),this.Maslosoft.Ilmatar||(this.Maslosoft.Ilmatar={}),this.Maslosoft.Ilmatar.Widgets||(this.Maslosoft.Ilmatar.Widgets={}),this.Maslosoft.Ilmatar.Widgets||(this.Maslosoft.Ilmatar.Widgets={}),this.Maslosoft.Ilmatar.Widgets.Gallery||(this.Maslosoft.Ilmatar.Widgets.Gallery={}),this.Maslosoft.Ilmatar.Widgets.Gallery.Presenter=function(){function b(b){this.resize=a(this.resize,this),this.showImage=a(this.showImage,this),this.zoomOut=a(this.zoomOut,this),this.urlMouseMove=a(this.urlMouseMove,this),this.mouseMove=a(this.mouseMove,this),this._fadeOutControls=a(this._fadeOutControls,this),this.fadeControls=a(this.fadeControls,this),this.vm=b.vm,this.element=jQuery("#"+b.id),this.overlay=this.element.find(".maslosoft-gallery-overlay"),this.view=this.overlay.find(".maslosoft-gallery-group-view"),this.row=this.view.find(".maslosoft-gallery-image-row"),this.controls=this.overlay.find(".maslosoft-gallery-controls"),this.thumbs=this.controls.find(".maslosoft-gallery-controls-thumbs"),this.thumbsSelector=this.controls.find(".maslosoft-gallery-controls-thumbs-selector"),this.play=this.element.find(".maslosoft-gallery-play"),this.pause=this.element.find(".maslosoft-gallery-pause"),this.viewable={width:0,height:0},b.options.fadeControls&&(jQuery(document).on("mousemove",this.mouseMove),this.element.on("mousemove","a[rel='tooltip']",this.urlMouseMove),jQuery(document).on("mousedown",this.fadeControls),jQuery(document).on("keydown",this.fadeControls),this.fadeControls())}return b.prototype.id="",b.prototype.element=null,b.prototype.overlay=null,b.prototype.view=null,b.prototype.row=null,b.prototype.controls=null,b.prototype.play=null,b.prototype.stop=null,b.prototype.moves=100,b.prototype.timer=null,b.prototype.fadeControls=function(a,b){return this.controls.stop(!0,!0),this.controls.fadeIn(),clearTimeout(this.timer),this.timer=setTimeout(this._fadeOutControls,5e3)},b.prototype._fadeOutControls=function(){return this.controls.fadeOut("slow")},b.prototype.mouseMove=function(a,b){return this.moves++,this.moves>20?(console.log("mousemoves "+this.moves),this.moves=0,this.fadeControls(a,b)):void 0},b.prototype.urlMouseMove=function(a){return console.log("url mouse move"),a.stopPropagation()},b.prototype.zoomOut=function(a,b){return a.stopPropagation(),a.preventDefault(),this.showGroup()},b.prototype.showImage=function(){var a,b,c,d;return this._calculateHeight(),d=this.view,c="#mid-image-"+this.vm.selectedImage.id+" img",b=jQuery(c),a={height:0,width:0},a={},jQuery(".maslosoft-gallery-groups img").not(c).animate(a,200,function(){var a,b,d,e,f,g,h;for(b=jQuery(this),b.parent().hide(),f=b.parent().parents(".maslosoft-gallery-image-row"),g=[],d=0,e=f.length;e>d;d++)h=f[d],a=jQuery(h),a.find(c).length?g.push(void 0):g.push(a.hide());return g}),a={height:this.viewable.height,width:"auto"},a={},b.animate(a,500),b.addClass("maslosoft-gallery-zoom-out"),this.showOverlay()},b.prototype.showGroup=function(){var a,b;return a=jQuery(".maslosoft-gallery-groups"),a.find(".maslosoft-gallery-image-row").show(),a.find(".maslosoft-gallery-image-url").show(),b=a.find("img"),b.removeClass("maslosoft-gallery-zoom-out"),b.height(0),b.show(),this.showOverlay()},b.prototype.showOverlay=function(){return console.log("scrollHeight: "+document.body.scrollHeight),console.log("clientHeight: "+document.body.clientHeight),document.body.scrollHeight===document.body.clientHeight&&jQuery("body").addClass("maslosoft-gallery-body-scrolls"),this.overlay.show(),this._calculateHeight()},b.prototype.hideOverlay=function(){return this.overlay.hide(),jQuery("body").removeClass("maslosoft-gallery-body-scrolls")},b.prototype.resize=function(){return this._calculateHeight()},b.prototype._calculate=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(this.viewable={width:jQuery(window).width(),height:jQuery(window).height()},this.viewable.ar=this.viewable.width/this.viewable.height,k=this._getOutlineWidth(this.view),h=this._getOutlineHeight(this.view),this.view.width(this.viewable.width-k),this.view.height(this.viewable.height-h),b=this.view.find("img").first(),j=this._getOutlineWidth(b),i=this._getOutlineHeight(b),q=0,r=[],this.vm.selectedGroup){for(o=this.vm.selectedGroup.items,e=0,f=o.length;f>e;e++)b=o[e],a=(b.file.width+j)/(b.file.height+i),r.push(parseInt(100*a)),q+=a*this.view.height();for(this.imgAr=q/this.view.height(),p=Math.ceil(this.imgAr/this.viewable.ar),c=this.view.find("img"),console.log(c),c.height(Math.ceil(this.view.height()/p)-i),console.log("Total width: "+q+" (of images)"),console.log("View width: "+this.view.width()),console.log(r),console.log("Rows: "+p),n=this.linearPartition(r,p),d=0,l=0,g=n.length;g>l;l++)m=n[l],d+=m.length,console.log(d),jQuery(c[d-1]).parent().after("<div />");return this.selectThumbs()}},b.prototype.selectThumbs=function(){var a,b,c,d;return console.log("selectThumbs"),this.vm.selectedGroupIndex,this.thumbs.removeClass("maslosoft-gallery-controls-thumbs-active"),this.active=jQuery(this.thumbs.find("a")[this.vm.selectedGroupIndex]),this.active?(console.log(this.active),this.active.addClass("maslosoft-gallery-controls-thumbs-active"),c=this.active.offset(),d=this.active.width(),console.log(c),console.log("Left position: "+this.active.position().left),console.log("Right thumbs offset: "+(this.viewable.width-(this.active.offset().left+this.active.outerWidth()))),this.viewable.width/2<this.active.position().left+d/2?(console.log("Should scroll"),a=this.viewable.width/2-d/2,this.thumbsSelector.css({left:a,width:d}),b=a-c.left,console.log(this.active.position().left+" - "+b),this.thumbs.css({left:this.thumbs.offset().left+b})):(this.thumbs.css({left:0}),c=this.active.offset(),d=this.active.width(),this.thumbsSelector.css({left:c.left,width:d}),console.log("Should not scroll"),console.log(this.viewable.width+" / 2 - ("+(this.active.position().left+d/2)+")")),this.thumbsSelector.animate({boxShadow:"0px 0px 1000px 0px white"},2e3,null,function(a){return function(){return a.thumbsSelector.animate({boxShadow:"0px 0px 0px 0px white"},2e3)}}(this))):void 0},b.prototype._calculateHeight=function(){this._calculate()},b.prototype._getOutlineHeight=function(a){var b,c,d;return d=parseInt(a.css("padding-top"))+parseInt(a.css("padding-bottom")),c=parseInt(a.css("margin-top"))+parseInt(a.css("margin-bottom")),b=parseInt(a.css("border-top-width"))+parseInt(a.css("border-bottom-width")),d+c+b},b.prototype._getOutlineWidth=function(a){var b,c,d;return d=parseInt(a.css("padding-left"))+parseInt(a.css("padding-right")),c=parseInt(a.css("margin-left"))+parseInt(a.css("margin-right")),b=parseInt(a.css("border-left-width"))+parseInt(a.css("border-right-width")),d+c+b},b.prototype.linearPartition=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(h=a.length,0>=b)return[];if(b>h)return a.map(function(a){return[a]});for(q=function(){var a,c,d;for(d=[],s=a=0,c=h;c>=0?c>a:a>c;s=c>=0?++a:--a)d.push(function(){var a,c,d;for(d=[],r=a=0,c=b;c>=0?c>a:a>c;r=c>=0?++a:--a)d.push(0);return d}());return d}(),p=function(){var a,c,d;for(d=[],s=a=0,c=h-1;c>=0?c>a:a>c;s=c>=0?++a:--a)d.push(function(){var a,c,d;for(d=[],r=a=0,c=b-1;c>=0?c>a:a>c;r=c>=0?++a:--a)d.push(0);return d}());return d}(),d=f=0,l=h;l>=0?l>f:f>l;d=l>=0?++f:--f)q[d][0]=a[d]+(d?q[d-1][0]:0);for(e=i=0,m=b;m>=0?m>i:i>m;e=m>=0?++i:--i)q[0][e]=a[0];for(d=j=1,n=h;n>=1?n>j:j>n;d=n>=1?++j:--j)for(e=k=1,o=b;o>=1?o>k:k>o;e=o>=1?++k:--k)g=_.min(function(){var a,b,c;for(b=[],r=c=0,a=d;a>=0?a>c:c>a;r=a>=0?++c:--c)b.push([_.max([q[r][e-1],q[d][0]-q[r][0]]),r]);return b}(),function(a){return a[0]}),q[d][e]=g[0],p[d-1][e-1]=g[1];for(h-=1,b-=2,c=[];b>=0;)c=[function(){var c,e,f,g;for(f=[],d=g=c=p[h-1][b]+1,e=h+1;e>=c?e>g:g>e;d=e>=c?++g:--g)f.push(a[d]);return f}()].concat(c),h=p[h-1][b],b-=1;return[function(){var b,c,e;for(c=[],d=e=0,b=h+1;b>=0?b>e:e>b;d=b>=0?++e:--e)c.push(a[d]);return c}()].concat(c)},b}(),this.Maslosoft.Ilmatar.Widgets.Gallery.Actions=function(){function a(a){this.vm=a.vm,this.presenter=a.presenter,this.dm=new Maslosoft.Ilmatar.Widgets.Gallery.DataManager(a)}return a.prototype.vm=null,a.prototype.presenter=null,a.prototype.dm=null,a.prototype.page=function(a){},a.prototype.group=function(a){var b;return null==a&&(a=null),a?(b=this.dm.findGroup(a),console.log("Viewing group "+b.id),this.vm.selectedGroup=b):b=this.vm.selectedGroup,this.vm.selectedGroupIndex=this.dm.groupIndex(b),this.vm.nextGroup=this.dm.nextGroup(b),this.vm.prevGroup=this.dm.prevGroup(b),this.presenter.showGroup()},a.prototype.image=function(a){var b;return b=this.dm.findImage(a),console.log("Viewing image "+b.id),this.vm.selectedImage=b,this.presenter.showImage(),this.vm.selectedImage=b},a.prototype.close=function(a){return null==a&&(a=null),console.log("Forced close"),History.pushState(null,null,purl(window.location).attr("path")),this.presenter.hideOverlay()},a}(),this.Maslosoft.Ilmatar.Widgets.Gallery.Activities=function(){function b(b){this.slider=a(this.slider,this),this.vm=b.vm,this.dm=new Maslosoft.Ilmatar.Widgets.Gallery.DataManager(b),this.presenter=b.presenter,this.action=b.action}return b.prototype.vm=null,b.prototype.dm=null,b.prototype.action=null,b.prototype.presenter=null,b.prototype.slide=function(a){return this.vm.slide=!this.vm.slide,this.slider()},b.prototype.slider=function(){return this.vm.slide?this.vm.nextGroup?(this.action.group(this.dm.nextGroup(this.vm.selectedGroup)),setTimeout(this.slider,5e3)):(this.action.group(this.vm.firstGroup),this.vm.slide=!1,this.presenter.fadeControls()):void 0},b.prototype.fullscreen=function(a){return"true"===a?(this.vm.fullscreen=!0,screenfull.request()):(this.vm.fullscreen=!1,screenfull.exit())},b}(),this.Maslosoft.Ilmatar.Widgets.Gallery.DataManager=function(){function a(a){this.vm=a.vm,this.vm.firstGroup=this.vm.dp.data[0],this.vm.lastGroup=this.vm.dp.data[this.vm.dp.data.length-1]}return a.prototype.vm=null,a.prototype.findGroup=function(a){var b,c,d,e;for(a.id&&(a=a.id),e=this.vm.dp.data,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b;return!1},a.prototype.groupIndex=function(a){return this.vm.dp.data.indexOf(a)},a.prototype.nextGroup=function(a){var b;return b=this.vm.dp.data.indexOf(a),console.log,b>=0&&b<this.vm.dp.data.length-1?this.vm.dp.data[b+1]:!1},a.prototype.prevGroup=function(a){var b;return b=this.vm.dp.data.indexOf(a),b>0&&b-1<=this.vm.dp.data.length?this.vm.dp.data[b-1]:!1},a.prototype.findImage=function(a){var b,c,d,e,f,g,h,i;for(a.id&&(a=a.id),h=this.vm.dp.data,d=0,e=h.length;e>d;d++)for(b=h[d],i=b.items,g=0,f=i.length;f>g;g++)if(c=i[g],c.id===a)return c;return!1},a}(),this.Maslosoft.Ilmatar.Widgets.Gallery.Grid=function(){function a(a){this.vm=a.vm}return a.prototype.vm=null,a}(),this.Maslosoft.Ilmatar.Widgets.Gallery.GalleryWidget=function(){function b(b,c,d){this.id=b,this.vm=null!=c?c:{},this.options=null!=d?d:{},this.overlayClick=a(this.overlayClick,this),this.urlClick=a(this.urlClick,this),this.hashChange=a(this.hashChange,this),this.historyChange=a(this.historyChange,this),this.presenter=new Maslosoft.Ilmatar.Widgets.Gallery.Presenter(this),this.action=new Maslosoft.Ilmatar.Widgets.Gallery.Actions(this),this.activity=new Maslosoft.Ilmatar.Widgets.Gallery.Activities(this),this.presenter.element.on("click",".maslosoft-gallery-image-url",this.urlClick),this.presenter.overlay.on("click",".maslosoft-gallery-image-row",this.overlayClick),jQuery(window).resize(this.presenter.resize),History.Adapter.bind(window,"statechange",this.historyChange),this.historyChange()}return b.prototype.id="",b.prototype.options={},b.prototype.vm=null,b.prototype.presenter=null,b.prototype.action=null,b.prototype.activity=null,b.prototype.historyChange=function(){var a,b,c,d,e,f;d=History.getState(),e=purl(d.url),console.log("Processing url "+d.url),b=e.param();for(a in b){f=b[a],console.log(a+": "+f);break}return c=new RegExp(this.id+":"),console.log(c),a&&a.match(c)&&(a=a.replace(c,""),"function"==typeof this.action[a])?(console.log("Calling @action."+a+"()"),this.action[a](f),this):this.action.close()},b.prototype.hashChange=function(a){var b,c,d,e;return b=purl(a).attr("fragment"),d=b.split("="),c=d.shift(),e=d.shift(),c&&"function"==typeof this.activity[c]?(console.log("Calling @activity."+c+"()"),this.activity[c](e),this):this},b.prototype.urlClick=function(a){var b,c,d;return a.preventDefault(),a.stopPropagation(),b=jQuery(a.currentTarget),c=b.data("id"),d=b.data("title"),console.log("Clicked link "+a.currentTarget.href),History.pushState(null,d,a.currentTarget.href),this.hashChange(a.currentTarget.href),!1},b.prototype.overlayClick=function(a){return console.log("Maybe clicked overlay..."),console.log(a),jQuery(a.target).is(".maslosoft-gallery-image-row")?(console.log("Ok, closing on overlay click"),History.pushState(null,null,purl(window.location).attr("path")),this.presenter.hideOverlay()):void 0},b}()}).call(this);